# HTML编辑器架构设计文档

## 1. 整体架构

HTML编辑器采用模块化、分层设计，遵循SOLID原则，主要使用命令模式、观察者模式、状态模式、访问者模式和依赖注入等设计模式。

### 1.1 分层结构

```
+-----------------+
|   Application   | 应用层：命令行界面、应用启动
+-----------------+
        |
+-----------------+
|    Session      | 会话层：会话管理、状态管理
+-----------------+
        |
+-----------------+
|    Commands     | 命令层：各类编辑、显示命令，命令历史
+-----------------+
        |
+-----------------+
|     Core        | 核心层：模型定义、异常处理
+-----------------+
        |
+-----------------+
|      I/O        | 输入输出层：文件读写、HTML解析
+-----------------+
        |
+-----------------+
|   SpellCheck    | 拼写检查层：拼写检查、语言工具适配器
+-----------------+
        |
+-----------------+
|     Utils       | 工具层：HTML工具、验证工具
+-----------------+
```

### 1.2 模块依赖关系

```
+------------+       +------------+       +------------+       +------------+
|     I/O    | <---- |    Core    | <---- |  Commands  | <---- |   Session  |
+------------+       +------------+       +------------+       +------------+
      ^                    ^                    ^                    ^
      |                    |                    |                    |
      |                    |                    |                    |
+------------+             |                    |                    |
|   Utils    | -----------+--------------------+                     |
+------------+                                                       |
      ^                                                              |
      |                +------------+                                |
      +--------------- | SpellCheck | <------------------------------+
                       +------------+                                |
                                                                     |
                                                            +------------------+
                                                            |   Application    |
                                                            +------------------+
```

## 2. 主要模块说明

### 2.1 核心模块 (Core)

核心模块定义了HTML模型的基本结构和操作。

#### 2.1.1 主要组件

- **Element**: 表示HTML元素的基础类，包含标签名、ID、文本内容和子元素等信息
- **HtmlModel**: 管理整个HTML文档树，提供元素查找、添加、删除等操作
- **异常类**: 定义各类异常，包括DuplicateIdError、ElementNotFoundError等

#### 2.1.2 设计决策

- 采用组合模式来表示HTML的树形结构
- 使用ID索引提高元素查找效率
- 通过异常处理和返回值指示操作结果

### 2.2 命令模块 (Commands)

命令模块实现各种编辑和显示命令，采用命令模式设计。

#### 2.2.1 主要组件

- **Base**: 命令基类，定义执行和撤销接口
- **CommandExceptions**: 命令相关异常定义
- **Observer**: 实现观察者模式，用于命令变更通知

子模块:
- **Display Commands**: PrintTreeCommand, SpellCheckCommand, DirTreeCommand
- **Do Commands**: 实现撤销、重做、历史记录管理
- **Edit Commands**: InsertCommand, AppendCommand, DeleteCommand, EditTextCommand, EditIdCommand
- **IO Commands**: ReadCommand, SaveCommand, InitCommand

#### 2.2.2 设计决策

- 使用命令模式实现撤销/重做功能
- 命令类型分为可记录和不可记录两类
- 每个命令保存执行所需的所有状态，以便撤销
- 使用观察者模式实现命令执行后的通知机制

### 2.3 输入输出模块 (I/O)

处理文件读写和HTML解析。

#### 2.3.1 主要组件

- **Parser**: HTML解析器，将HTML文本转换为模型
- **Writer**: HTML写入器，将模型保存为HTML文本

#### 2.3.2 设计决策

- 使用适配器模式封装第三方HTML解析库
- 通过工厂方法创建解析器和写入器的实例

### 2.4 拼写检查模块 (SpellCheck)

提供对HTML文本内容的拼写检查功能。

#### 2.4.1 主要组件

- **Checker**: 拼写检查器接口及默认实现
- **Adapters**: 不同拼写检查工具的适配器
  - **LanguageTool**: 集成LanguageTool进行更高级的语法检查

#### 2.4.2 设计决策

- 使用策略模式实现不同的拼写检查算法
- 通过适配器模式集成不同的拼写检查工具
- 通过依赖注入解耦检查器和报告器
- 使用访问者模式遍历HTML树进行检查

### 2.5 会话模块 (Session)

管理编辑器的会话状态。

#### 2.5.1 主要组件

- **SessionManager**: 会话管理器，控制会话生命周期
- **State**: 使用状态模式管理不同的会话状态

#### 2.5.2 设计决策

- 使用状态模式管理会话的不同状态
- 单例模式实现SessionManager
- 封装全局状态，提供统一访问接口

### 2.6 应用模块 (Application)

应用层负责命令解析和程序流程控制。

#### 2.6.1 主要组件

- **CommandParser**: 命令解析器
- **Main**: 应用入口和主循环

#### 2.6.2 设计决策

- 采用简单工厂模式创建命令对象
- 使用单例模式管理全局状态

### 2.7 工具模块 (Utils)

提供通用工具方法。

#### 2.7.1 主要组件

- **HtmlUtils**: HTML处理相关工具函数
- **Validator**: 数据验证工具

#### 2.7.2 设计决策

- 静态工具类设计，提供无状态服务
- 集中处理常用功能，避免代码重复

## 3. 关键设计模式应用

### 3.1 命令模式 (Command Pattern)

- **应用**: 所有编辑操作通过命令对象封装
- **优势**: 实现撤销/重做功能，解耦操作请求和操作执行

### 3.2 组合模式 (Composite Pattern)

- **应用**: HTML元素树结构
- **优势**: 统一处理单个元素和元素组合

### 3.3 访问者模式 (Visitor Pattern)

- **应用**: 拼写检查和树形显示
- **优势**: 在不修改元素类的情况下添加新的操作

### 3.4 依赖注入 (Dependency Injection)

- **应用**: SpellCheckCommand依赖ISpellChecker和SpellErrorReporter
- **优势**: 提高代码灵活性和可测试性

### 3.5 适配器模式 (Adapter Pattern)

- **应用**: 封装第三方HTML解析库和拼写检查工具
- **优势**: 隔离第三方依赖，提高可维护性

### 3.6 观察者模式 (Observer Pattern)

- **应用**: 命令执行后的通知机制
- **优势**: 解耦命令执行和状态更新

### 3.7 状态模式 (State Pattern)

- **应用**: 会话状态管理
- **优势**: 将状态相关行为封装到独立类中，简化状态转换逻辑

## 4. 扩展性考虑

该架构设计充分考虑了扩展性需求：

1. **新命令添加**: 只需创建新的Command子类
2. **新显示格式**: 实现新的Reporter接口
3. **替换拼写检查引擎**: 实现Checker接口或创建新的适配器
4. **UI扩展**: 命令模式便于添加图形界面
5. **新会话状态**: 扩展State类添加新状态

## 5. 限制与权衡

1. **性能考量**: ID索引提高查找效率，但增加了内存消耗
2. **复杂度**: 使用多种设计模式增加了代码复杂度
3. **第三方依赖**: 尽量限制在I/O模块中，通过适配器隔离

## 6. 模块依赖关系图

```
+---------------+     +---------------+     +---------------+     +---------------+
| core.element  |<----| core.html_model|<----| commands.base |<----| session.state |
+---------------+     +---------------+     +---------------+     +---------------+
        ^                    ^                     ^                     ^
        |                    |                     |                     |
+---------------+     +---------------+     +---------------+     +---------------+
|core.exceptions|     | io.parser     |     |commands.edit  |     |session.manager|
+---------------+     +---------------+     +---------------+     +---------------+
                            ^                     ^                     ^
                            |                     |                     |
                    +---------------+     +---------------+             |
                    | io.writer     |     |commands.display|             |
                    +---------------+     +---------------+             |
                            ^                     ^                     |
                            |                     |                     |
                    +---------------+     +---------------+             |
                    |utils.html_utils|     |spellcheck.checker|         |
                    +---------------+     +---------------+             |
                                                 ^                     |
                                                 |                     |
                                         +---------------+             |
                                         |spellcheck.adapters|         |
                                         +---------------+             |
                                                 ^                     |
                                                 |                     |
                                         +---------------+     +---------------+
                                         |commands.do    |<----|application.main|
                                         +---------------+     +---------------+
                                                                      ^
                                                                      |
                                                              +---------------+
                                                              |application.parser|
                                                              +---------------+
```

## 7. 测试策略

1. **单元测试**: 针对每个类的功能测试
2. **集成测试**: 测试模块间的交互
3. **系统测试**: 验证整个编辑器功能

测试覆盖关键路径和边缘情况，确保功能稳定性.
